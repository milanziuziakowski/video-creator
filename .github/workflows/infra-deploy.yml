# AI Video Creator - Infrastructure Deployment Pipeline
# Deploys Azure infrastructure using Bicep templates

name: Infrastructure Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  validate:
    name: Validate Bicep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep template
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az deployment sub validate \
              --location westeurope \
              --template-file infra/main.bicep \
              --parameters infra/parameters/${{ github.event.inputs.environment }}.parameters.json \
              --parameters postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD }}' \
              --parameters openaiApiKey='${{ secrets.OPENAI_API_KEY }}' \
              --parameters minimaxApiKey='${{ secrets.MINIMAX_API_KEY }}'

  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep template
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az deployment sub create \
              --location westeurope \
              --template-file infra/main.bicep \
              --parameters infra/parameters/${{ github.event.inputs.environment }}.parameters.json \
              --parameters postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD }}' \
              --parameters openaiApiKey='${{ secrets.OPENAI_API_KEY }}' \
              --parameters minimaxApiKey='${{ secrets.MINIMAX_API_KEY }}'

      - name: Output deployment results
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az deployment sub show \
              --name main \
              --query properties.outputs
